//
// TAKO
// ip/address.hpp
// ~~~~~~~~~~~~~~
//
// Copyright (c) 2003-2022 Christopher M. Kohlhoff (chris at kohlhoff dot com)
//
// Distributed under the Boost Software License, Version 1.0. (See accompanying
// file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
//

#ifndef ASIO_IP_ADDRESS_HPP
#define ASIO_IP_ADDRESS_HPP

#if defined(_MSC_VER) && (_MSC_VER >= 1200)
# pragma once
#endif // defined(_MSC_VER) && (_MSC_VER >= 1200)

#include "asio/detail/config.hpp"
#include <string>
#include "asio/detail/throw_exception.hpp"
#include "asio/detail/string_view.hpp"
#include "asio/detail/type_traits.hpp"
#include "asio/error_code.hpp"
#include "asio/ip/address_v4.hpp"
#include "asio/ip/address_v6.hpp"
#include "asio/ip/bad_address_cast.hpp"

#if defined(ASIO_HAS_STD_HASH)
# include <functional>
#endif // defined(ASIO_HAS_STD_HASH)

#if !defined(ASIO_NO_IOSTREAM)
# include <iosfwd>
#endif // !defined(ASIO_NO_IOSTREAM)

#include "asio/detail/push_options.hpp"

namespace asio {
namespace ip {

/// Implements version-independent IP addresses.
/**
 * The asio::ip::address class provides the ability to use either IP
 * version 4 or version 6 addresses.
 * 【这个adress类其实用type_指明了地址是v4还是v6的，里面其实持有两个address_v4和address_v6对象】
 *
 * @par Thread Safety
 * @e Distinct @e objects: Safe.@n
 * @e Shared @e objects: Unsafe.
 */
class address
{
public:
  /// Default constructor.默认地址构造函数
  ASIO_DECL address() ASIO_NOEXCEPT;

  /// Construct an address from an IPv4 address. 【ipv4地址创建地址】
  ASIO_DECL address(
      const asio::ip::address_v4& ipv4_address) ASIO_NOEXCEPT;

  /// Construct an address from an IPv6 address.  【ipv6创建】
  ASIO_DECL address(
      const asio::ip::address_v6& ipv6_address) ASIO_NOEXCEPT;

  /// Copy constructor. 【拷贝构造】
  ASIO_DECL address(const address& other) ASIO_NOEXCEPT;

#if defined(ASIO_HAS_MOVE)
  /// Move constructor. 【移动构造】
  ASIO_DECL address(address&& other) ASIO_NOEXCEPT;
#endif // defined(ASIO_HAS_MOVE)

  /// Assign from another address. 【复制拷贝】
  ASIO_DECL address& operator=(const address& other) ASIO_NOEXCEPT;

#if defined(ASIO_HAS_MOVE)
  /// Move-assign from another address. 【传递移动】
  ASIO_DECL address& operator=(address&& other) ASIO_NOEXCEPT;
#endif // defined(ASIO_HAS_MOVE)

  /// Assign from an IPv4 address. 【从ipv4=拷贝】
  ASIO_DECL address& operator=(
      const asio::ip::address_v4& ipv4_address) ASIO_NOEXCEPT;

  /// Assign from an IPv6 address. 【从ipv6=拷贝】
  ASIO_DECL address& operator=(
      const asio::ip::address_v6& ipv6_address) ASIO_NOEXCEPT;

  /// Get whether the address is an IP version 4 address.   【判断是否是v4】
  bool is_v4() const ASIO_NOEXCEPT
  {
    return type_ == ipv4;
  }

  /// Get whether the address is an IP version 6 address. 【判断是否是v6】
  bool is_v6() const ASIO_NOEXCEPT
  {
    return type_ == ipv6;
  }

  /// Get the address as an IP version 4 address. 【将地址转换成v4】
  ASIO_DECL asio::ip::address_v4 to_v4() const;

  /// Get the address as an IP version 6 address. 【将地址转换成v6】
  ASIO_DECL asio::ip::address_v6 to_v6() const;

  /// Get the address as a string.  【将地址转换成字符串】
  ASIO_DECL std::string to_string() const;

#if !defined(ASIO_NO_DEPRECATED)    // 【已经删除的函数】
  /// (Deprecated: Use other overload.) Get the address as a string.
  ASIO_DECL std::string to_string(asio::error_code& ec) const;

  /// (Deprecated: Use make_address().) Create an address from an IPv4 address
  /// string in dotted decimal form, or from an IPv6 address in hexadecimal
  /// notation. 
  static address from_string(const char* str);  

  /// (Deprecated: Use make_address().) Create an address from an IPv4 address
  /// string in dotted decimal form, or from an IPv6 address in hexadecimal
  /// notation.
  static address from_string(const char* str, asio::error_code& ec);

  /// (Deprecated: Use make_address().) Create an address from an IPv4 address
  /// string in dotted decimal form, or from an IPv6 address in hexadecimal
  /// notation.
  static address from_string(const std::string& str);

  /// (Deprecated: Use make_address().) Create an address from an IPv4 address
  /// string in dotted decimal form, or from an IPv6 address in hexadecimal
  /// notation.
  static address from_string(
      const std::string& str, asio::error_code& ec);
#endif // !defined(ASIO_NO_DEPRECATED)

  /// Determine whether the address is a loopback address. 【地址是否回环】
  ASIO_DECL bool is_loopback() const ASIO_NOEXCEPT;

  /// Determine whether the address is unspecified. 【地址是否未指定的位址[为空]】
  ASIO_DECL bool is_unspecified() const ASIO_NOEXCEPT;  

  /// Determine whether the address is a multicast address. 【地址是否多播】
  ASIO_DECL bool is_multicast() const ASIO_NOEXCEPT;

  /// Compare two addresses for equality.   【[友元]判断两个地址是否相等】
  ASIO_DECL friend bool operator==(const address& a1,
      const address& a2) ASIO_NOEXCEPT;

  /// Compare two addresses for inequality. 【[友元]判断两个地址是否不等】
  friend bool operator!=(const address& a1,
      const address& a2) ASIO_NOEXCEPT
  {
    return !(a1 == a2);
  }

  /// Compare addresses for ordering.   【判断两个地址的小于顺序】
  ASIO_DECL friend bool operator<(const address& a1,
      const address& a2) ASIO_NOEXCEPT;

  /// Compare addresses for ordering.   【判断地址的大于顺序】
  friend bool operator>(const address& a1,
      const address& a2) ASIO_NOEXCEPT
  {
    return a2 < a1;
  }

  /// Compare addresses for ordering.   【判断两个地址小于等于】
  friend bool operator<=(const address& a1,
      const address& a2) ASIO_NOEXCEPT
  {
    return !(a2 < a1);
  }

  /// Compare addresses for ordering.   【判断两个地址大于等于】
  friend bool operator>=(const address& a1,
      const address& a2) ASIO_NOEXCEPT
  {
    return !(a1 < a2);
  }

private:
  // The type of the address.   【类型只有ipv4/ipv6】
  enum { ipv4, ipv6 } type_;

  // The underlying IPv4 address.   【ipv4地址】
  asio::ip::address_v4 ipv4_address_;

  // The underlying IPv6 address.   【ipv6地址】
  asio::ip::address_v6 ipv6_address_;
};

/// Create an address from an IPv4 address string in dotted decimal form,
/// or from an IPv6 address in hexadecimal notation.
/// 【传入const char*】
/// 【ipv4以十进制创建，ipv6以16进制创建】
/**
 * @relates address
 */
ASIO_DECL address make_address(const char* str);

/// Create an address from an IPv4 address string in dotted decimal form,
/// or from an IPv6 address in hexadecimal notation.
/// 【传入const char*】
/// 【ipv4以十进制创建，ipv6以16进制创建[带错误码&ec]】
/**
 * @relates address
 */
ASIO_DECL address make_address(const char* str,
    asio::error_code& ec) ASIO_NOEXCEPT;

/// Create an address from an IPv4 address string in dotted decimal form,
/// or from an IPv6 address in hexadecimal notation.
/// 【传入const string&】
/// 【ipv4以十进制创建，ipv6以16进制创建】
/**
 * @relates address
 */
ASIO_DECL address make_address(const std::string& str);

/// Create an address from an IPv4 address string in dotted decimal form,
/// or from an IPv6 address in hexadecimal notation.
/// 【传入const string&】
/// 【ipv4以十进制创建，ipv6以16进制创建[带错误码&ec]】
/**
 * @relates address
 */
ASIO_DECL address make_address(const std::string& str,
    asio::error_code& ec) ASIO_NOEXCEPT;

#if defined(ASIO_HAS_STRING_VIEW) \
  || defined(GENERATING_DOCUMENTATION)
/// C++17 after only

/// Create an address from an IPv4 address string in dotted decimal form,
/// or from an IPv6 address in hexadecimal notation.
/// 【传入const string_view】
/// 【ipv4以十进制创建，ipv6以16进制创建】
/**
 * @relates address
 */
ASIO_DECL address make_address(string_view str);

/// Create an address from an IPv4 address string in dotted decimal form,
/// or from an IPv6 address in hexadecimal notation.
/// 【传入const string_view】
/// 【ipv4以十进制创建，ipv6以16进制创建[带错误码&ec]】
/**
 * @relates address
 */
ASIO_DECL address make_address(string_view str,
    asio::error_code& ec) ASIO_NOEXCEPT;

#endif // defined(ASIO_HAS_STRING_VIEW)
       //  || defined(GENERATING_DOCUMENTATION)

#if !defined(ASIO_NO_IOSTREAM)
/// 开启了IOSTREAM参数时

/// Output an address as a string.
/**
 * Used to output a human-readable string for a specified address.
 *
 * @param os The output stream to which the string will be written.
 *
 * @param addr The address to be written.
 *
 * @return The output stream.
 *
 * @relates asio::ip::address
 */
template <typename Elem, typename Traits>
std::basic_ostream<Elem, Traits>& operator<<(
    std::basic_ostream<Elem, Traits>& os, const address& addr);

#endif // !defined(ASIO_NO_IOSTREAM)

} // namespace ip
} // namespace asio

#if defined(ASIO_HAS_STD_HASH)
// 如果使用了std自带的hash
namespace std {

template <>
struct hash<asio::ip::address>
{
  std::size_t operator()(const asio::ip::address& addr)
    const ASIO_NOEXCEPT
  {
      // 根据ip地址类型使用对应的hash
    return addr.is_v4()
      ? std::hash<asio::ip::address_v4>()(addr.to_v4())
      : std::hash<asio::ip::address_v6>()(addr.to_v6());
  }
};

} // namespace std
#endif // defined(ASIO_HAS_STD_HASH)

#include "asio/detail/pop_options.hpp"

#include "asio/ip/impl/address.hpp"
#if defined(ASIO_HEADER_ONLY)
# include "asio/ip/impl/address.ipp"
#endif // defined(ASIO_HEADER_ONLY)

#endif // ASIO_IP_ADDRESS_HPP
